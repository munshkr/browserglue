<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>browserglue example</title>
</head>

<body>
    <h1>browserglue testbed</h1>
    <p>Open the Developer Tools and check the console log. You can use a browserglue client at <code>bg</code>
        (<code>window.bg</code>).</p>
</body>
<script src="browserglue.js"></script>
<script type="text/javascript">
    (async () => {
        const client = new browserglue.Client('ws://localhost:8000');
        window.bg = client;

        console.log("Remove all channels first");
        await client.removeAllChannels();

        console.log("Add channel /foo binded to udp:4000")
        const channel = await client.addChannel("/foo", 4000);
        // Handle messages
        channel.on(async blob => {
            const text = await blob.text();
            console.log("[/foo]", text);
        });

        // Remove channel after 3 seconds
        console.log("Remove channel /foo in 3 seconds...");
        setTimeout(async () => {
            console.log("Remove channel /foo");
            channel.remove();
            const channels = await client.getChannels();
            console.log("Current channels:", channels);
        }, 3000);

        // Add another channel
        console.log("Add channel /bar");
        const barChannel = await client.addChannel("/bar", 5000);
        console.log("Subscribe port 5010 on /bar");
        barChannel.subscribePort(5010);
        console.log("Subscribe port 5011 on /bar");
        barChannel.subscribePort(5011);
        // Handle messages
        barChannel.on(async blob => {
            const text = await blob.text();
            console.log("[/bar]", text);
        });

        // Remove channel after 3 seconds
        setTimeout(async () => {
            console.log("Unsubscribe port 5010 on channel /bar");
            barChannel.unsubscribePort(5010);
            console.log("/bar Channel instance:", barChannel);
        }, 500);

        // List all channels
        client.getChannels().then(channels => console.log("Current channels:", channels));

        setInterval(() => {
            const now = new Date();
            const msg = `this message was sent at ${now.toISOString()}`;
            console.log("Publish to /bar:", msg);
            barChannel.publish(msg);
        }, 3000);
    })();
</script>

</html>