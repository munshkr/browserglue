<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>browserglue example</title>
</head>

<body>
    <h1>browserglue testbed</h1>
    <p>You can use a browserglue client at <code>bg</code> (<code>window.bg</code>).</p>
    <pre id="log"></pre>
</body>
<script src="browserglue.js"></script>
<script type="text/javascript">
    (async () => {
        const logEl = document.getElementById("log");
        const log = (msg, ...args) => {
            console.log(msg, ...args);
            logEl.innerText += [msg, ...args].join(' ') + "\n";
        }

        const client = new browserglue.Client('ws://localhost:8000');
        window.bg = client;

        log("Remove all channels first");
        await client.removeAllChannels();

        log("Add channel /foo binded to udp:4000")
        const channel = await client.addChannel("/foo", 4000);
        // Handle messages
        channel.on(message => {
            log("[/foo]", message);
        });

        // Remove channel after 3 seconds
        log("Remove channel /foo in 3 seconds...");
        setTimeout(async () => {
            log("Remove channel /foo");
            channel.remove();
            const channels = await client.getChannels();
            log("Current channels:", channels);
        }, 3000);

        // Add another channel
        log("Add channel /bar");
        const barChannel = await client.addChannel("/bar");
        log("Subscribe port 5010 on /bar");
        channel.subscribePort(5010);
        log("Subscribe port 5011 on /bar");
        channel.subscribePort(5011);

        // List all channels
        client.getChannels().then(channels => log("Current channels:", channels));
    })();
</script>

</html>